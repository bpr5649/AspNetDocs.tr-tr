---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: ASP.NET mvc'de siteler arası istek sahteciliği (CSRF) saldırılarını önleme
author: MikeWasson
description: Siteler arası istek sahteciliği (CSRF) saldırı ve ASP.NET Web MVC'de kötü CSRF önlemlerini açıklar.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 04/09/2019
ms.locfileid: "59392033"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a><span data-ttu-id="f9474-103">ASP.NET MVC uygulamasındaki siteler arası istek sahteciliği (CSRF) saldırılarını önleme</span><span class="sxs-lookup"><span data-stu-id="f9474-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application</span></span>

<span data-ttu-id="f9474-104">tarafından [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="f9474-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="f9474-105">Burada bir kötü niyetli site burada kullanıcı şu anda oturum savunmasız sitesine bir istek gönderir, siteler arası istek sahteciliği (CSRF) bir saldırı olma</span><span class="sxs-lookup"><span data-stu-id="f9474-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="f9474-106">CSRF saldırılarının bir örnek aşağıda verilmiştir:</span><span class="sxs-lookup"><span data-stu-id="f9474-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="f9474-107">Bir kullanıcının oturum açtığı `www.example.com` forms kimlik doğrulaması kullanma.</span><span class="sxs-lookup"><span data-stu-id="f9474-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="f9474-108">Sunucusu kullanıcının kimliğini doğrular.</span><span class="sxs-lookup"><span data-stu-id="f9474-108">The server authenticates the user.</span></span> <span data-ttu-id="f9474-109">Sunucu yanıtı bir kimlik doğrulama tanımlama bilgisi içerir.</span><span class="sxs-lookup"><span data-stu-id="f9474-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="f9474-110">Kullanıcı oturumu kapatmak olmadan kötü amaçlı web sitesini ziyaret eder.</span><span class="sxs-lookup"><span data-stu-id="f9474-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="f9474-111">Bu kötü niyetli site aşağıdaki HTML formu içerir:</span><span class="sxs-lookup"><span data-stu-id="f9474-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="f9474-112">Form eylemi kötü niyetli site için güvenlik açığı siteye gönderir dikkat edin.</span><span class="sxs-lookup"><span data-stu-id="f9474-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="f9474-113">CSRF "siteler arası" parçasıdır.</span><span class="sxs-lookup"><span data-stu-id="f9474-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="f9474-114">Kullanıcının gönder düğmesine tıklar.</span><span class="sxs-lookup"><span data-stu-id="f9474-114">The user clicks the submit button.</span></span> <span data-ttu-id="f9474-115">Tarayıcı, kimlik doğrulama tanımlama bilgisi ile istek içerir.</span><span class="sxs-lookup"><span data-stu-id="f9474-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="f9474-116">İstek, kullanıcının kimlik doğrulaması bağlamı sunucunuz üzerinde çalışan ve kimliği doğrulanmış bir kullanıcıyı yapmak için izin verilen herhangi bir şey yapabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="f9474-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="f9474-117">Bu örnekte form düğmesini tıklatarak kullanıcı gerektirse de, kötü amaçlı sayfası kolayca otomatik olarak formu gönderdiği bir betik çalıştırma gibi olabilir.</span><span class="sxs-lookup"><span data-stu-id="f9474-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="f9474-118">Ayrıca, SSL kullanarak, bunlar "https://" istek kötü niyetli site gönderebileceğinden bile, CSRF saldırısını engellemez.</span><span class="sxs-lookup"><span data-stu-id="f9474-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="f9474-119">Genellikle, tarayıcılar ilgili tüm tanımlama bilgilerini hedef web sitesine göndermek için CSRF saldırılarına karşı kimlik doğrulaması için tanımlama bilgileri kullanan web siteleri mümkün olabilir.</span><span class="sxs-lookup"><span data-stu-id="f9474-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="f9474-120">Ancak, CSRF saldırıları tanımlama bilgilerinin kötüye için sınırlı değildir.</span><span class="sxs-lookup"><span data-stu-id="f9474-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="f9474-121">Örneğin, temel ve Özet kimlik doğrulaması ayrıca savunmasız.</span><span class="sxs-lookup"><span data-stu-id="f9474-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="f9474-122">Sonra bir kullanıcı oturum temel veya Özet kimlik doğrulamasını açın.</span><span class="sxs-lookup"><span data-stu-id="f9474-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="f9474-123">oturum sonlandırılana kadar tarayıcı kimlik bilgilerini otomatik olarak gönderir.</span><span class="sxs-lookup"><span data-stu-id="f9474-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="f9474-124">Sahteciliğe karşı koruma belirteçleri</span><span class="sxs-lookup"><span data-stu-id="f9474-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="f9474-125">ASP.NET MVC CSRF saldırılarını önlemeye yardımcı olmak için olarak da bilinir, sahteciliğe karşı koruma belirteçleri kullanır *doğrulama belirteci istemek*.</span><span class="sxs-lookup"><span data-stu-id="f9474-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="f9474-126">İstemci, bir form içeren bir HTML sayfası ister.</span><span class="sxs-lookup"><span data-stu-id="f9474-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="f9474-127">Sunucunun yanıtta iki belirteçleri içerir.</span><span class="sxs-lookup"><span data-stu-id="f9474-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="f9474-128">Bir simge bir tanımlama bilgisi gönderilir.</span><span class="sxs-lookup"><span data-stu-id="f9474-128">One token is sent as a cookie.</span></span> <span data-ttu-id="f9474-129">Diğer bir gizli form alanına yerleştirilir.</span><span class="sxs-lookup"><span data-stu-id="f9474-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="f9474-130">Böylece bir saldırganın değerleri tahmin edilemez belirteçleri rastgele oluşturulur.</span><span class="sxs-lookup"><span data-stu-id="f9474-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="f9474-131">İstemci formu gönderdiğinde, bu sunucuya geri hem belirteçleri göndermeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="f9474-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="f9474-132">Bir tanımlama bilgisi tanımlama bilgisi belirteci istemciye gönderir ve formu içinde form belirteç gönderir.</span><span class="sxs-lookup"><span data-stu-id="f9474-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="f9474-133">(Kullanıcı formu gönderdiğinde tarayıcı istemci otomatik olarak bunu yapar.)</span><span class="sxs-lookup"><span data-stu-id="f9474-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="f9474-134">Bir isteği her iki simge içermiyorsa, sunucu istek izin vermiyor.</span><span class="sxs-lookup"><span data-stu-id="f9474-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="f9474-135">Bir HTML formuna gizli form belirteci ile bir örneği aşağıda verilmiştir:</span><span class="sxs-lookup"><span data-stu-id="f9474-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="f9474-136">Sahteciliğe karşı koruma belirteçleri çalışır, çünkü kötü amaçlı sayfası aynı çıkış noktası ilkeleri nedeniyle kullanıcının belirteçleri okunamıyor.</span><span class="sxs-lookup"><span data-stu-id="f9474-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="f9474-137">([Aynı çıkış noktası ilkeleri](http://www.w3.org/Security/wiki/Same_Origin_Policy) birbirlerinin içeriğe erişmesini iki farklı sitelerde barındırılan belge engelle.</span><span class="sxs-lookup"><span data-stu-id="f9474-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="f9474-138">Bu nedenle önceki örnekte, kötü amaçlı sayfası istekleri example.com gönderebilir, ancak yanıt okunamıyor.)</span><span class="sxs-lookup"><span data-stu-id="f9474-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="f9474-139">Kullanıcı oturum açtığında sonra CSRF saldırıların önlenmesine, tarayıcı sessizce göndereceği yeri sahteciliğe karşı koruma belirteçleri ile herhangi bir kimlik doğrulama protokolünü kullanmak için kimlik bilgileri.</span><span class="sxs-lookup"><span data-stu-id="f9474-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="f9474-140">Bu tanımlama bilgisi tabanlı kimlik doğrulama protokolleri, forms kimlik doğrulaması gibi içerir hem de temel ve Özet kimlik doğrulaması gibi protokoller.</span><span class="sxs-lookup"><span data-stu-id="f9474-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="f9474-141">Sahteciliğe karşı koruma belirteçleri için tüm nonsafe yöntemleri (POST, PUT, DELETE) istemeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="f9474-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="f9474-142">Ayrıca güvenli yöntemleri (GET, HEAD) yan etkileri sahip olmadığından emin olun.</span><span class="sxs-lookup"><span data-stu-id="f9474-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="f9474-143">CORS veya JSONP, gibi etki alanları arası destek etkinleştirirseniz, ayrıca, sonra da güvenli GET gibi hassas olabilecek verileri okumak, saldırganın CSRF saldırılarına karşı savunmasız yöntemlerdir.</span><span class="sxs-lookup"><span data-stu-id="f9474-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="f9474-144">ASP.NET mvc'de sahteciliğe karşı koruma belirteçleri</span><span class="sxs-lookup"><span data-stu-id="f9474-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="f9474-145">Sahteciliğe karşı koruma belirteçleri için bir Razor sayfası eklemek için **HtmlHelper.AntiForgeryToken** yardımcı yöntemi:</span><span class="sxs-lookup"><span data-stu-id="f9474-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="f9474-146">Bu yöntem, gizli form alanının ekler ve ayrıca tanımlama bilgisi belirteci ayarlar.</span><span class="sxs-lookup"><span data-stu-id="f9474-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="f9474-147">Anti-CSRF ve AJAX</span><span class="sxs-lookup"><span data-stu-id="f9474-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="f9474-148">Form simgesi HTML form verileri JSON verilerini bir AJAX isteği gönderebilir AJAX istekleri için bir sorun olabilir.</span><span class="sxs-lookup"><span data-stu-id="f9474-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="f9474-149">Tek bir çözüm, özel bir HTTP üst bilgisinde belirteçleri göndermektir.</span><span class="sxs-lookup"><span data-stu-id="f9474-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="f9474-150">Aşağıdaki kod, belirteçleri oluşturmak için Razor sözdizimini kullanır ve ardından belirteçleri için bir AJAX isteği ekler.</span><span class="sxs-lookup"><span data-stu-id="f9474-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="f9474-151">Çağırarak sunucuda oluşturulan belirteçleri **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="f9474-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="f9474-152">İsteği işlerken, istek üstbilgisi belirteçleri ayıklayın.</span><span class="sxs-lookup"><span data-stu-id="f9474-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="f9474-153">Ardından çağırın **AntiForgery.Validate** belirteçleri doğrulamak için yöntemi.</span><span class="sxs-lookup"><span data-stu-id="f9474-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="f9474-154">**Doğrulama** yöntemi belirteçleri geçerli değilse bir özel durum oluşturur.</span><span class="sxs-lookup"><span data-stu-id="f9474-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
