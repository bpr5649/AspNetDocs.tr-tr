---
uid: web-api/overview/security/authentication-filters
title: ASP.NET Web API 2 ' deki kimlik doğrulama filtreleri | Microsoft Docs
author: MikeWasson
description: Bir kimlik doğrulama filtresi, HTTP isteğinin kimliğini doğrulayan bir bileşendir. Web API 2 ve MVC 5 her ikisi de kimlik doğrulama filtrelerini destekler, ancak biraz farklı...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: b6815baf05303d5f47a14ee5fe0fdfc2836c1868
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519381"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="163c6-104">ASP.NET Web API 2 ' deki kimlik doğrulama filtreleri</span><span class="sxs-lookup"><span data-stu-id="163c6-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="163c6-105">, [Mike te son](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="163c6-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="163c6-106">Bir kimlik doğrulama filtresi, HTTP isteğinin kimliğini doğrulayan bir bileşendir.</span><span class="sxs-lookup"><span data-stu-id="163c6-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="163c6-107">Web API 2 ve MVC 5 her ikisi de kimlik doğrulama filtrelerini destekler, ancak çoğunlukla filtre arabirimine ilişkin adlandırma kurallarına göre biraz farklılık gösterir.</span><span class="sxs-lookup"><span data-stu-id="163c6-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="163c6-108">Bu konu, Web API kimlik doğrulama filtrelerini açıklamaktadır.</span><span class="sxs-lookup"><span data-stu-id="163c6-108">This topic describes Web API authentication filters.</span></span>

<span data-ttu-id="163c6-109">Kimlik doğrulama filtreleri, bireysel denetleyiciler veya eylemler için bir kimlik doğrulama düzeni ayarlamanıza olanak sağlar.</span><span class="sxs-lookup"><span data-stu-id="163c6-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="163c6-110">Bu şekilde, uygulamanız farklı HTTP kaynakları için farklı kimlik doğrulama mekanizmalarını destekleyebilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="163c6-111">Bu makalede, [https://github.com/aspnet/samples](https://github.com/aspnet/samples) [temel kimlik doğrulama](http://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) örneğinden kod göstereceğim.</span><span class="sxs-lookup"><span data-stu-id="163c6-111">In this article, I'll show code from the [Basic Authentication](http://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample on [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span></span> <span data-ttu-id="163c6-112">Örnek, HTTP temel erişim kimlik doğrulama şemasını (RFC 2617) uygulayan bir kimlik doğrulama filtresi gösterir.</span><span class="sxs-lookup"><span data-stu-id="163c6-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="163c6-113">Filtre, `IdentityBasicAuthenticationAttribute`adlı bir sınıfta uygulanır.</span><span class="sxs-lookup"><span data-stu-id="163c6-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="163c6-114">Örnekten yalnızca bir kimlik doğrulama filtresinin nasıl yazılacağını gösteren parçalar olan kodun tümünü göstermiyorum.</span><span class="sxs-lookup"><span data-stu-id="163c6-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="163c6-115">Kimlik doğrulama filtresi ayarlama</span><span class="sxs-lookup"><span data-stu-id="163c6-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="163c6-116">Diğer filtreler gibi, kimlik doğrulama filtreleri denetleyici başına, eyleme göre veya genel olarak tüm Web API denetleyicilerine uygulanabilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="163c6-117">Bir denetleyiciye kimlik doğrulama filtresi uygulamak için, denetleyici sınıfını filtre özniteliğiyle süsleyerek.</span><span class="sxs-lookup"><span data-stu-id="163c6-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="163c6-118">Aşağıdaki kod, denetleyicinin tüm eylemleri için temel kimlik doğrulamaya izin veren bir Controller sınıfında `[IdentityBasicAuthentication]` filtresini ayarlar.</span><span class="sxs-lookup"><span data-stu-id="163c6-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="163c6-119">Filtreyi bir eyleme uygulamak için eylemi filtreyle süsleyerek.</span><span class="sxs-lookup"><span data-stu-id="163c6-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="163c6-120">Aşağıdaki kod denetleyicinin `Post` yönteminde `[IdentityBasicAuthentication]` filtresini ayarlar.</span><span class="sxs-lookup"><span data-stu-id="163c6-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="163c6-121">Filtreyi tüm Web API denetleyicilerine uygulamak için **Globalconfiguration. Filters**öğesine ekleyin.</span><span class="sxs-lookup"><span data-stu-id="163c6-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="163c6-122">Web API kimlik doğrulama filtresi uygulama</span><span class="sxs-lookup"><span data-stu-id="163c6-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="163c6-123">Web API 'sinde, kimlik doğrulama filtreleri [System. Web. http. Filters. ıauthenticationfilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) arabirimini uygular.</span><span class="sxs-lookup"><span data-stu-id="163c6-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="163c6-124">Ayrıca, öznitelikler olarak uygulanması için **System. Attribute**'tan de devralması gerekir.</span><span class="sxs-lookup"><span data-stu-id="163c6-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="163c6-125">**Iauthenticationfilter** arabiriminin iki yöntemi vardır:</span><span class="sxs-lookup"><span data-stu-id="163c6-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="163c6-126">Kimlik **doğrulayan ekip eşitleme** , istekte kimlik bilgilerini doğrulayarak isteğin kimliğini doğrular.</span><span class="sxs-lookup"><span data-stu-id="163c6-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="163c6-127">Yanıt, gerekirse HTTP yanıtına bir kimlik doğrulama **sınaması ekler.**</span><span class="sxs-lookup"><span data-stu-id="163c6-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="163c6-128">Bu yöntemler, [rfc 2612](http://tools.ietf.org/html/rfc2616) ve [RFC 2617](http://tools.ietf.org/html/rfc2617)' de tanımlanan kimlik doğrulama akışına karşılık gelir:</span><span class="sxs-lookup"><span data-stu-id="163c6-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="163c6-129">İstemci kimlik bilgilerini yetkilendirme üst bilgisinde gönderir.</span><span class="sxs-lookup"><span data-stu-id="163c6-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="163c6-130">Bu durum genellikle istemci sunucudan 401 (yetkisiz) yanıt aldıktan sonra oluşur.</span><span class="sxs-lookup"><span data-stu-id="163c6-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="163c6-131">Ancak, bir istemci yalnızca 401 aldıktan sonra değil, herhangi bir istek ile kimlik bilgilerini gönderebilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="163c6-132">Sunucu kimlik bilgilerini kabul etmezse, 401 (yetkisiz) yanıtını döndürür.</span><span class="sxs-lookup"><span data-stu-id="163c6-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="163c6-133">Yanıt, bir veya daha fazla zorluk içeren bir WWW-Authenticate üst bilgisi içerir.</span><span class="sxs-lookup"><span data-stu-id="163c6-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="163c6-134">Her zorluk, sunucu tarafından tanınan bir kimlik doğrulama şemasını belirtir.</span><span class="sxs-lookup"><span data-stu-id="163c6-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="163c6-135">Sunucu, anonim bir istekten 401 de döndürebilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="163c6-136">Aslında, genellikle kimlik doğrulama işlemi nasıl başlatılmıştı:</span><span class="sxs-lookup"><span data-stu-id="163c6-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="163c6-137">İstemci anonim bir istek gönderir.</span><span class="sxs-lookup"><span data-stu-id="163c6-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="163c6-138">Sunucu 401 döndürür.</span><span class="sxs-lookup"><span data-stu-id="163c6-138">The server returns 401.</span></span>
3. <span data-ttu-id="163c6-139">İstemciler isteği kimlik bilgileriyle yeniden sonlandırır.</span><span class="sxs-lookup"><span data-stu-id="163c6-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="163c6-140">Bu akış hem *kimlik doğrulama* hem de *Yetkilendirme* adımlarını içerir.</span><span class="sxs-lookup"><span data-stu-id="163c6-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="163c6-141">Kimlik doğrulama, istemcinin kimliğini kanıtlar.</span><span class="sxs-lookup"><span data-stu-id="163c6-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="163c6-142">Yetkilendirme, istemcinin belirli bir kaynağa erişip erişemeyeceğini belirler.</span><span class="sxs-lookup"><span data-stu-id="163c6-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="163c6-143">Web API 'de, kimlik doğrulama filtreleri kimlik doğrulamasını işler, ancak yetkilendirmeyi işlemez.</span><span class="sxs-lookup"><span data-stu-id="163c6-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="163c6-144">Yetkilendirme, yetkilendirme filtresi veya denetleyici eylemi içinde yapılmalıdır.</span><span class="sxs-lookup"><span data-stu-id="163c6-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="163c6-145">Web API 2 ardışık düzeninde akış aşağıda verilmiştir:</span><span class="sxs-lookup"><span data-stu-id="163c6-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="163c6-146">Bir eylemi çağırmadan önce Web API 'SI, bu eyleme yönelik kimlik doğrulama filtrelerinin bir listesini oluşturur.</span><span class="sxs-lookup"><span data-stu-id="163c6-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="163c6-147">Buna eylem kapsamı, denetleyici kapsamı ve genel kapsama sahip filtreler dahildir.</span><span class="sxs-lookup"><span data-stu-id="163c6-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="163c6-148">Web API 'SI, listedeki her filtrede **kimlik doğrulayan ekip eşitlemesini** çağırır.</span><span class="sxs-lookup"><span data-stu-id="163c6-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="163c6-149">Her filtre istekteki kimlik bilgilerini doğrulayabilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="163c6-150">Herhangi bir filtre kimlik bilgilerini başarıyla doğrularırsa, filtre bir **IPrincipal** oluşturur ve bunu isteğe ekler.</span><span class="sxs-lookup"><span data-stu-id="163c6-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="163c6-151">Bu noktada bir filtre de bir hata tetiklenebilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="163c6-152">Öyleyse, ardışık düzen geri kalanı çalışmaz.</span><span class="sxs-lookup"><span data-stu-id="163c6-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="163c6-153">Bir hata olmadığı varsayılarak, istek işlem hattının geri kalanı üzerinden akar.</span><span class="sxs-lookup"><span data-stu-id="163c6-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="163c6-154">Son olarak, Web API her kimlik doğrulama filtresinin her ne **zaman uyumsuz** yöntemini çağırır.</span><span class="sxs-lookup"><span data-stu-id="163c6-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="163c6-155">Filtreler, gerekirse yanıta bir sınama eklemek için bu yöntemi kullanır.</span><span class="sxs-lookup"><span data-stu-id="163c6-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="163c6-156">Genellikle bir 401 hatasına yanıt olarak gerçekleştirilecek olan (her zaman değil).</span><span class="sxs-lookup"><span data-stu-id="163c6-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="163c6-157">Aşağıdaki diyagramlarda iki olası durum gösterilmektedir.</span><span class="sxs-lookup"><span data-stu-id="163c6-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="163c6-158">İlk olarak, kimlik doğrulama filtresi isteğin kimliğini başarıyla doğrular, bir yetkilendirme filtresi isteği yetkilendirir ve denetleyici eylemi 200 döndürür (Tamam).</span><span class="sxs-lookup"><span data-stu-id="163c6-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="163c6-159">İkinci örnekte, kimlik doğrulama filtresi isteğin kimliğini doğrular, ancak yetkilendirme filtresi 401 (yetkisiz) değerini döndürür.</span><span class="sxs-lookup"><span data-stu-id="163c6-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="163c6-160">Bu durumda, denetleyici eylemi çağrılmaz.</span><span class="sxs-lookup"><span data-stu-id="163c6-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="163c6-161">Kimlik doğrulama filtresi, yanıta bir WWW-Authenticate üst bilgisi ekler.</span><span class="sxs-lookup"><span data-stu-id="163c6-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="163c6-162">Diğer birleşimler olasıdır&mdash;Örneğin, denetleyici eylemi anonim isteklere izin veriyorsa, bir kimlik doğrulama filtreniz olabilir ancak yetkilendirmenize sahip olabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="163c6-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="163c6-163">Kimlik doğrulayan Teasync metodunu uygulama</span><span class="sxs-lookup"><span data-stu-id="163c6-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="163c6-164">**Kimlik doğrulayan Teasync** yöntemi isteğin kimliğini doğrulamaya çalışır.</span><span class="sxs-lookup"><span data-stu-id="163c6-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="163c6-165">Yöntem imzası şöyledir:</span><span class="sxs-lookup"><span data-stu-id="163c6-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="163c6-166">**Kimlik doğrulayan Teasync** yöntemi aşağıdakilerden birini yapmanız gerekir:</span><span class="sxs-lookup"><span data-stu-id="163c6-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="163c6-167">Nothing (Hayır-op).</span><span class="sxs-lookup"><span data-stu-id="163c6-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="163c6-168">Bir **IPrincipal** oluşturun ve istekte ayarlayın.</span><span class="sxs-lookup"><span data-stu-id="163c6-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="163c6-169">Bir hata sonucu ayarlayın.</span><span class="sxs-lookup"><span data-stu-id="163c6-169">Set an error result.</span></span>

<span data-ttu-id="163c6-170">(1) seçeneği, isteğin, filtrenin anladığı kimlik bilgilerine sahip olmadığı anlamına gelir.</span><span class="sxs-lookup"><span data-stu-id="163c6-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="163c6-171">(2) seçeneği, filtrenin isteği başarıyla doğruladığını gösterir.</span><span class="sxs-lookup"><span data-stu-id="163c6-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="163c6-172">(3) seçeneği, isteğin geçersiz kimlik bilgilerine sahip olduğu anlamına gelir (yanlış parola gibi) ve bu da hata yanıtı tetikler.</span><span class="sxs-lookup"><span data-stu-id="163c6-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="163c6-173">**Kimlik doğrulayan ekip eşitlemesini**uygulamak için genel bir ana hat aşağıda verilmiştir.</span><span class="sxs-lookup"><span data-stu-id="163c6-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="163c6-174">İstekteki kimlik bilgilerini arayın.</span><span class="sxs-lookup"><span data-stu-id="163c6-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="163c6-175">Kimlik bilgileri yoksa, hiçbir şey yapmayın ve döndürün (Hayır-op).</span><span class="sxs-lookup"><span data-stu-id="163c6-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="163c6-176">Kimlik bilgileri varsa ancak filtre kimlik doğrulama düzenini algılamazsa hiçbir şey yapmayın ve döndürün (Hayır-op).</span><span class="sxs-lookup"><span data-stu-id="163c6-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="163c6-177">İşlem hattındaki başka bir filtre düzeni anlayabilir.</span><span class="sxs-lookup"><span data-stu-id="163c6-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="163c6-178">Filtrenin anladığı kimlik bilgileri varsa, kimlik doğrulaması yapmayı deneyin.</span><span class="sxs-lookup"><span data-stu-id="163c6-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="163c6-179">Kimlik bilgileri bozuksa, `context.ErrorResult`ayarlayarak 401 döndürün.</span><span class="sxs-lookup"><span data-stu-id="163c6-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="163c6-180">Kimlik bilgileri geçerliyse, bir **IPrincipal** oluşturun ve `context.Principal`ayarlayın.</span><span class="sxs-lookup"><span data-stu-id="163c6-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="163c6-181">Takip kodu, [temel kimlik doğrulama](http://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) örneğinden **kimlik doğrulayan teasync** yöntemini gösterir.</span><span class="sxs-lookup"><span data-stu-id="163c6-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample.</span></span> <span data-ttu-id="163c6-182">Açıklamalar her adımı gösterir.</span><span class="sxs-lookup"><span data-stu-id="163c6-182">The comments indicate each step.</span></span> <span data-ttu-id="163c6-183">Kod birçok hata türünü gösterir: kimlik bilgileri olmayan bir yetkilendirme üstbilgisi, hatalı biçimlendirilmiş kimlik bilgileri ve hatalı Kullanıcı adı/parola.</span><span class="sxs-lookup"><span data-stu-id="163c6-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="163c6-184">Hata sonucunu ayarlama</span><span class="sxs-lookup"><span data-stu-id="163c6-184">Setting an Error Result</span></span>

<span data-ttu-id="163c6-185">Kimlik bilgileri geçersizse, filtrenin bir hata yanıtı oluşturan **ıhttpactionresult** `context.ErrorResult` ayarlaması gerekir.</span><span class="sxs-lookup"><span data-stu-id="163c6-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="163c6-186">**Ihttpactionresult**hakkında daha fazla bilgi için bkz. [Web API 2 ' de eylem sonuçları](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="163c6-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="163c6-187">Temel kimlik doğrulama örneği, bu amaçla uygun bir `AuthenticationFailureResult` sınıfını içerir.</span><span class="sxs-lookup"><span data-stu-id="163c6-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="163c6-188">Requesgeasync uygulama</span><span class="sxs-lookup"><span data-stu-id="163c6-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="163c6-189">Yanıt **verme yönteminin amacı, gerekirse** yanıta kimlik doğrulama güçlükleri eklemektir.</span><span class="sxs-lookup"><span data-stu-id="163c6-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="163c6-190">Yöntem imzası şöyledir:</span><span class="sxs-lookup"><span data-stu-id="163c6-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="163c6-191">Yöntemi, istek ardışık düzeninde her kimlik doğrulama filtresinde çağrılır.</span><span class="sxs-lookup"><span data-stu-id="163c6-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="163c6-192">HTTP yanıtı oluşturulmadan *önce* , Istene **zaman uyumsuz** olarak çağrıldığını ve denetleyici eyleminin çalıştırılmasından önce bile, yanıt verme işlemini anlamak önemlidir.</span><span class="sxs-lookup"><span data-stu-id="163c6-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="163c6-193">Yanıt **verme isteği çağrıldığında `context.Result`** , daha sonra http yanıtı oluşturmak için kullanılan bir **ıhttpactionresult**içerir.</span><span class="sxs-lookup"><span data-stu-id="163c6-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="163c6-194">Bu nedenle, yanıt verme **isteği ÇAĞRıLDıĞıNDA http** yanıtıyla ilgili hiçbir şeyi henüz bilemezsiniz.</span><span class="sxs-lookup"><span data-stu-id="163c6-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="163c6-195">Bu **, `context.Result`** özgün değerini yeni bir **ıhttpactionresult**ile değiştirin.</span><span class="sxs-lookup"><span data-stu-id="163c6-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="163c6-196">Bu **ıhttpactionresult** , özgün `context.Result`sarmalıdır.</span><span class="sxs-lookup"><span data-stu-id="163c6-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="163c6-197">Özgün **ıhttpactionresult** *iç sonucu*çağıracağım ve yeni **ıhttpactionresult** , *dıştaki sonucu*.</span><span class="sxs-lookup"><span data-stu-id="163c6-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="163c6-198">Dış sonuç şunları sağlamalıdır:</span><span class="sxs-lookup"><span data-stu-id="163c6-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="163c6-199">HTTP yanıtını oluşturmak için iç sonucu çağırın.</span><span class="sxs-lookup"><span data-stu-id="163c6-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="163c6-200">Yanıtı inceleyin.</span><span class="sxs-lookup"><span data-stu-id="163c6-200">Examine the response.</span></span>
3. <span data-ttu-id="163c6-201">Gerekirse yanıta bir kimlik doğrulama sınaması ekleyin.</span><span class="sxs-lookup"><span data-stu-id="163c6-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="163c6-202">Aşağıdaki örnek, temel kimlik doğrulama örneğinden alınmıştır.</span><span class="sxs-lookup"><span data-stu-id="163c6-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="163c6-203">Dış sonuç için bir **ıhttpactionresult** tanımlar.</span><span class="sxs-lookup"><span data-stu-id="163c6-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="163c6-204">`InnerResult` özelliği, iç **ıhttpactionresult**öğesini içerir.</span><span class="sxs-lookup"><span data-stu-id="163c6-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="163c6-205">`Challenge` özelliği bir www-Authentication üst bilgisini temsil eder.</span><span class="sxs-lookup"><span data-stu-id="163c6-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="163c6-206">**ExecuteAsync** , HTTP yanıtını oluşturmak için ilk `InnerResult.ExecuteAsync` çağırır ve gerekirse zorluğu ekler.</span><span class="sxs-lookup"><span data-stu-id="163c6-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="163c6-207">Sınamayı eklemeden önce yanıt kodunu kontrol edin.</span><span class="sxs-lookup"><span data-stu-id="163c6-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="163c6-208">Çoğu kimlik doğrulama düzeni, burada gösterildiği gibi yalnızca yanıt 401 ise bir zorluk ekler.</span><span class="sxs-lookup"><span data-stu-id="163c6-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="163c6-209">Ancak, bazı kimlik doğrulama şemaları başarı yanıtına bir zorluk ekler.</span><span class="sxs-lookup"><span data-stu-id="163c6-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="163c6-210">Örneğin bkz. [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="163c6-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="163c6-211">`AddChallengeOnUnauthorizedResult` sınıfı verildiğinde,, bu, fiili kodu, bu, **zaman uyumsuz** ' de basittir.</span><span class="sxs-lookup"><span data-stu-id="163c6-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="163c6-212">Yalnızca sonucu oluşturup `context.Result`iliştirebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="163c6-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="163c6-213">Note: temel kimlik doğrulama örneği bu mantığı bir genişletme yöntemine yerleştirerek bir bit soyutlar.</span><span class="sxs-lookup"><span data-stu-id="163c6-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="163c6-214">Kimlik doğrulama filtrelerini ana bilgisayar düzeyinde kimlik doğrulama ile birleştirme</span><span class="sxs-lookup"><span data-stu-id="163c6-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="163c6-215">"Ana bilgisayar düzeyinde kimlik doğrulaması", istek Web API çerçevesine ulaşmadan önce konak tarafından (IIS gibi) gerçekleştirilen kimlik doğrulamadır.</span><span class="sxs-lookup"><span data-stu-id="163c6-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="163c6-216">Genellikle uygulamanızın geri kalanı için ana bilgisayar düzeyinde kimlik doğrulamasını etkinleştirmek isteyebilir, ancak Web API denetleyicileriniz için devre dışı bırakabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="163c6-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="163c6-217">Örneğin, tipik bir senaryo, form kimlik doğrulamasını konak düzeyinde etkinleştirmektir, ancak Web API için belirteç tabanlı kimlik doğrulaması kullanır.</span><span class="sxs-lookup"><span data-stu-id="163c6-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="163c6-218">Web API ardışık düzeninde ana bilgisayar düzeyinde kimlik doğrulamasını devre dışı bırakmak için, yapılandırmanızda `config.SuppressHostPrincipal()` çağırın.</span><span class="sxs-lookup"><span data-stu-id="163c6-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="163c6-219">Bu, Web API 'sinin, Web API ardışık düzenine giren herhangi bir istekten **IPrincipal** 'ı kaldırmasına neden olur.</span><span class="sxs-lookup"><span data-stu-id="163c6-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="163c6-220">Bu, isteği&quot; &quot;kimliğini doğrular.</span><span class="sxs-lookup"><span data-stu-id="163c6-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="163c6-221">Ek Kaynaklar</span><span class="sxs-lookup"><span data-stu-id="163c6-221">Additional Resources</span></span>

<span data-ttu-id="163c6-222">[ASP.NET Web API 'Si güvenlik filtreleri](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="163c6-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
