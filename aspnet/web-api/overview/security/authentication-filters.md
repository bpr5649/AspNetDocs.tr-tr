---
uid: web-api/overview/security/authentication-filters
title: ASP.NET Web API 2'de kimlik doğrulama filtreleri | Microsoft Docs
author: MikeWasson
description: Bir kimlik doğrulaması filtresini, HTTP isteği yapan bir bileşenidir. Web API 2 ve MVC 5 kimlik doğrulama filtreleri her ikisini de destekler, ancak bunlar biraz farklı...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: a14facad4cbd0f9be1ff7bde2667f61ec8cc2a14
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 03/01/2019
ms.locfileid: "57067617"
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="71d12-104">ASP.NET Web API 2'de kimlik doğrulama filtreleri</span><span class="sxs-lookup"><span data-stu-id="71d12-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="71d12-105">tarafından [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="71d12-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="71d12-106">Bir kimlik doğrulaması filtresini, HTTP isteği yapan bir bileşenidir.</span><span class="sxs-lookup"><span data-stu-id="71d12-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="71d12-107">Web API 2 ve MVC 5 kimlik doğrulama filtreleri her ikisini de destekler, ancak bunlar çoğunlukla filtre arabirimi için adlandırma kuralları olarak biraz farklılık.</span><span class="sxs-lookup"><span data-stu-id="71d12-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="71d12-108">Bu konuda, Web API'si kimlik doğrulama filtreleri açıklanmaktadır.</span><span class="sxs-lookup"><span data-stu-id="71d12-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="71d12-109">Kimlik doğrulaması filtreleri bireysel denetleyicileri veya eylemler için bir kimlik doğrulama düzeni ayarlamanıza olanak tanır.</span><span class="sxs-lookup"><span data-stu-id="71d12-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="71d12-110">Böylece, uygulamanızı farklı HTTP kaynaklar için farklı kimlik doğrulama mekanizmaları destekler.</span><span class="sxs-lookup"><span data-stu-id="71d12-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="71d12-111">Bu makalede, ı koddan göstereceğiz [temel kimlik doğrulaması](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) örneğine [ http://aspnet.codeplex.com ](http://aspnet.codeplex.com).</span><span class="sxs-lookup"><span data-stu-id="71d12-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com).</span></span> <span data-ttu-id="71d12-112">Örnek HTTP temel erişimi kimlik doğrulaması şeması (RFC 2617) uygulayan bir kimlik doğrulaması filtresini gösterir.</span><span class="sxs-lookup"><span data-stu-id="71d12-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="71d12-113">Filtre adlı bir sınıfta uygulandığını `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="71d12-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="71d12-114">Ben tüm örnek kodu bir kimlik doğrulaması filtresini yazmak nasıl çalışılacağını bölümleri gösterilmez.</span><span class="sxs-lookup"><span data-stu-id="71d12-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="71d12-115">Bir kimlik doğrulaması filtresini ayarlama</span><span class="sxs-lookup"><span data-stu-id="71d12-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="71d12-116">Diğer filtreleri gibi kimlik doğrulama filtreleri denetleyici başına uygulanan, eylem başına veya genel olarak tüm Web APİ'si denetleyicilerinin olabilir.</span><span class="sxs-lookup"><span data-stu-id="71d12-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="71d12-117">Bir denetleyici için bir kimlik doğrulaması filtresini uygulamak için filtre özniteliği ile denetleyici sınıfı süslemek.</span><span class="sxs-lookup"><span data-stu-id="71d12-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="71d12-118">Aşağıdaki kod kümeleri `[IdentityBasicAuthentication]` tüm denetleyicinin eylemler için temel kimlik doğrulaması sağlayan bir denetleyici sınıfı filtre.</span><span class="sxs-lookup"><span data-stu-id="71d12-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="71d12-119">Bir eylem için filtre uygulamak için eylem filtreyle süslemek.</span><span class="sxs-lookup"><span data-stu-id="71d12-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="71d12-120">Aşağıdaki kod kümeleri `[IdentityBasicAuthentication]` denetleyicinin filtre `Post` yöntemi.</span><span class="sxs-lookup"><span data-stu-id="71d12-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="71d12-121">Tüm Web APİ'si denetleyicilerinin için filtre uygulamak için eklemeniz **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="71d12-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="71d12-122">Bir Web API'si kimlik doğrulama filtre uygulama</span><span class="sxs-lookup"><span data-stu-id="71d12-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="71d12-123">Web API'de kimlik doğrulaması filtreleri uygulamak [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) arabirimi.</span><span class="sxs-lookup"><span data-stu-id="71d12-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="71d12-124">Ayrıca devralındığı **System.Attribute**öznitelikler uygulanması için.</span><span class="sxs-lookup"><span data-stu-id="71d12-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="71d12-125">**IAuthenticationFilter** arabirimi iki yöntem vardır:</span><span class="sxs-lookup"><span data-stu-id="71d12-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="71d12-126">**AuthenticateAsync** isteğin istek kimlik bilgilerini doğrulayarak varsa kimliğini doğrular.</span><span class="sxs-lookup"><span data-stu-id="71d12-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="71d12-127">**ChallengeAsync** gerekirse HTTP yanıt, bir kimlik doğrulaması sınaması ekler.</span><span class="sxs-lookup"><span data-stu-id="71d12-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="71d12-128">Bu yöntemler tanımlanan kimlik doğrulama akışı karşılık [RFC 2612](http://tools.ietf.org/html/rfc2616) ve [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="71d12-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="71d12-129">İstemci kimlik bilgileri yetkilendirme üst bilgisinde gönderir.</span><span class="sxs-lookup"><span data-stu-id="71d12-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="71d12-130">Bu durum, genellikle istemcinin sunucudan bir 401 (yetkisiz) yanıt aldıktan sonra gerçekleşir.</span><span class="sxs-lookup"><span data-stu-id="71d12-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="71d12-131">Ancak, bir istemci, yalnızca bir 401 aldıktan sonra herhangi bir isteği ile kimlik bilgileri gönderebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="71d12-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="71d12-132">Sunucu kimlik bilgileri kabul etmez 401 (yetkisiz) bir yanıt döndürür.</span><span class="sxs-lookup"><span data-stu-id="71d12-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="71d12-133">Yanıt, bir veya daha fazla sorunlarını içeren bir Www-Authenticate üstbilgisi içeriyor.</span><span class="sxs-lookup"><span data-stu-id="71d12-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="71d12-134">Her sınama sunucu tarafından tanınan bir kimlik doğrulama düzeni belirtir.</span><span class="sxs-lookup"><span data-stu-id="71d12-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="71d12-135">Sunucu bir anonim isteğinden 401 geri dönebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="71d12-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="71d12-136">Aslında, genellikle kimlik doğrulama işlemi nasıl başlatılır olmasıdır:</span><span class="sxs-lookup"><span data-stu-id="71d12-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="71d12-137">İstemci, anonim bir istek gönderir.</span><span class="sxs-lookup"><span data-stu-id="71d12-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="71d12-138">Sunucu 401 döndürür.</span><span class="sxs-lookup"><span data-stu-id="71d12-138">The server returns 401.</span></span>
3. <span data-ttu-id="71d12-139">İstemciler, istekle birlikte kimlik bilgileri yeniden gönderir.</span><span class="sxs-lookup"><span data-stu-id="71d12-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="71d12-140">Bu akış her ikisini de içeren *kimlik doğrulaması* ve *yetkilendirme* adımları.</span><span class="sxs-lookup"><span data-stu-id="71d12-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="71d12-141">Kimlik doğrulaması, istemci kimliğini kanıtlar.</span><span class="sxs-lookup"><span data-stu-id="71d12-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="71d12-142">Yetkilendirme, bir istemci belirli bir kaynağa erişip erişemeyeceğini belirler.</span><span class="sxs-lookup"><span data-stu-id="71d12-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="71d12-143">Web API'de kimlik doğrulaması, ancak değil yetkilendirme kimlik doğrulaması filtreleri işleyin.</span><span class="sxs-lookup"><span data-stu-id="71d12-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="71d12-144">Yetkilendirme denetleyici eylemi içinde veya bir yetkilendirme Filtresi tarafından yapılması gerekir.</span><span class="sxs-lookup"><span data-stu-id="71d12-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="71d12-145">Web API 2 kanaldaki akışı şöyledir:</span><span class="sxs-lookup"><span data-stu-id="71d12-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="71d12-146">Web API'si, bir eylem çağırmadan önce bu eylemi için kimlik doğrulama filtrelerinin listesi oluşturur.</span><span class="sxs-lookup"><span data-stu-id="71d12-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="71d12-147">Bu eylem kapsamını, denetleyicisi kapsamı ve genel kapsam filtrelerle içerir.</span><span class="sxs-lookup"><span data-stu-id="71d12-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="71d12-148">Web API çağrıları **AuthenticateAsync** her filtre listesinde üzerinde.</span><span class="sxs-lookup"><span data-stu-id="71d12-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="71d12-149">Her filtre istekteki kimlik doğrulayabilir.</span><span class="sxs-lookup"><span data-stu-id="71d12-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="71d12-150">Herhangi bir filtre başarıyla kimlik bilgilerini doğrular, filtre oluşturur. bir **IPrincipal** ve isteği ekler.</span><span class="sxs-lookup"><span data-stu-id="71d12-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="71d12-151">Bir filtre da bu noktada hata tetikleyebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="71d12-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="71d12-152">Bu durumda, kalan ardışık düzenini çalıştırmaz.</span><span class="sxs-lookup"><span data-stu-id="71d12-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="71d12-153">Hiçbir hata olmadığını varsayarsak, istek ardışık düzenin rest üzerinden akar.</span><span class="sxs-lookup"><span data-stu-id="71d12-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="71d12-154">Son olarak, her kimlik doğrulama filtrenin Web API'si çağıran **ChallengeAsync** yöntemi.</span><span class="sxs-lookup"><span data-stu-id="71d12-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="71d12-155">Filtreler bu yöntem bir challenge, yanıt eklemek için gerekirse kullanın.</span><span class="sxs-lookup"><span data-stu-id="71d12-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="71d12-156">Genellikle (ama her zaman kullanılmaz), sorun 401 hatası için yanıt olacaktır.</span><span class="sxs-lookup"><span data-stu-id="71d12-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="71d12-157">Aşağıdaki diyagramlarda, iki olası durumların gösterir.</span><span class="sxs-lookup"><span data-stu-id="71d12-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="71d12-158">İlk kimlik doğrulaması filtresini istek kimliğini başarıyla doğrulayan ve bir yetkilendirme filtresi isteği yetkilendirir denetleyici eylemini 200 (Tamam) döndürür.</span><span class="sxs-lookup"><span data-stu-id="71d12-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="71d12-159">İkinci örnekte, kimlik doğrulaması filtresini isteğin kimliğini doğrular, ancak yetkilendirme filtresini 401 (yetkisiz) döndürür.</span><span class="sxs-lookup"><span data-stu-id="71d12-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="71d12-160">Bu durumda, denetleyici eylem çağrılmaz.</span><span class="sxs-lookup"><span data-stu-id="71d12-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="71d12-161">Kimlik doğrulaması filtresini bir Www-Authenticate üstbilgisi yanıta ekler.</span><span class="sxs-lookup"><span data-stu-id="71d12-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="71d12-162">Diğer olası birleşimleridir&mdash;denetleyici eylemini anonim isteklere izin veriyorsa, örneğin, bir kimlik doğrulaması filtresini ancak hiçbir kimlik olabilir.</span><span class="sxs-lookup"><span data-stu-id="71d12-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="71d12-163">AuthenticateAsync yöntemi uygulama</span><span class="sxs-lookup"><span data-stu-id="71d12-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="71d12-164">**AuthenticateAsync** yöntemi isteğin kimliğini dener.</span><span class="sxs-lookup"><span data-stu-id="71d12-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="71d12-165">Aşağıda, yöntem imzası verilmiştir:</span><span class="sxs-lookup"><span data-stu-id="71d12-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="71d12-166">**AuthenticateAsync** yöntemi aşağıdakilerden birini yapması gerekir:</span><span class="sxs-lookup"><span data-stu-id="71d12-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="71d12-167">Nothing (İşlemsiz).</span><span class="sxs-lookup"><span data-stu-id="71d12-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="71d12-168">Oluşturma bir **IPrincipal** ve istek üzerinde ayarlanan.</span><span class="sxs-lookup"><span data-stu-id="71d12-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="71d12-169">Bir hata sonucu ayarlayın.</span><span class="sxs-lookup"><span data-stu-id="71d12-169">Set an error result.</span></span>

<span data-ttu-id="71d12-170">(1) seçeneği anlamına gelir istek filtresi anlayan herhangi bir kimlik bilgisi yok.</span><span class="sxs-lookup"><span data-stu-id="71d12-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="71d12-171">Seçeneği (2) yol filtresi, isteği başarıyla kimlik doğrulaması.</span><span class="sxs-lookup"><span data-stu-id="71d12-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="71d12-172">Bir hata yanıtı tetikler (3) seçeneği anlamına gelir isteği, geçersiz kimlik bilgileri (yanlış parola gibi), vardı.</span><span class="sxs-lookup"><span data-stu-id="71d12-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="71d12-173">Uygulama için bir genel anahat işte **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="71d12-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="71d12-174">İstekteki kimlik bilgilerini arayın.</span><span class="sxs-lookup"><span data-stu-id="71d12-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="71d12-175">Kimlik bilgisi varsa, hiçbir şey yapma ve (İşlemsiz) döndürür.</span><span class="sxs-lookup"><span data-stu-id="71d12-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="71d12-176">Kimlik bilgileri vardır, ancak filtre kimlik doğrulama şeması tanımıyor, hiçbir şey yapma ve (İşlemsiz) döndürür.</span><span class="sxs-lookup"><span data-stu-id="71d12-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="71d12-177">Başka bir filtre ardışık düzen anlamak.</span><span class="sxs-lookup"><span data-stu-id="71d12-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="71d12-178">Filtre anlayan kimlik bilgileri varsa, bunları kimliğini doğrulamak deneyin.</span><span class="sxs-lookup"><span data-stu-id="71d12-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="71d12-179">Kimlik bilgileri hatalı ise 401 ayarlayarak döndürün `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="71d12-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="71d12-180">Kimlik bilgilerinin geçerli olduğundan, oluşturun bir **IPrincipal** ayarlayıp `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="71d12-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="71d12-181">Aşağıdaki kodun gösterdiği **AuthenticateAsync** yönteminden [temel kimlik doğrulaması](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) örnek.</span><span class="sxs-lookup"><span data-stu-id="71d12-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="71d12-182">Her adım yorumları belirtin.</span><span class="sxs-lookup"><span data-stu-id="71d12-182">The comments indicate each step.</span></span> <span data-ttu-id="71d12-183">Kod çeşitli hata türleri gösterilmektedir: Hiçbir kimlik bilgileri, hatalı biçimlendirilmiş kimlik bilgilerini ve hatalı kullanıcı adı/parola ile birlikte bir Authorization Üstbilgisi.</span><span class="sxs-lookup"><span data-stu-id="71d12-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="71d12-184">Bir hata sonucu ayarlama</span><span class="sxs-lookup"><span data-stu-id="71d12-184">Setting an Error Result</span></span>

<span data-ttu-id="71d12-185">Kimlik bilgileri geçersiz olduğunda filtre ayarlamalısınız `context.ErrorResult` için bir **Ihttpactionresult** bir hata yanıtı oluşturur.</span><span class="sxs-lookup"><span data-stu-id="71d12-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="71d12-186">Hakkında daha fazla bilgi için **Ihttpactionresult**, bkz: [Web API 2'de eylem sonuçları](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="71d12-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="71d12-187">Temel kimlik doğrulaması örneği içeren bir `AuthenticationFailureResult` bu amaç için uygun olan sınıfı.</span><span class="sxs-lookup"><span data-stu-id="71d12-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="71d12-188">ChallengeAsync uygulama</span><span class="sxs-lookup"><span data-stu-id="71d12-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="71d12-189">Amacı **ChallengeAsync** yöntemdir yanıt, kimlik doğrulama sınaması eklemeniz gerekirse.</span><span class="sxs-lookup"><span data-stu-id="71d12-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="71d12-190">Aşağıda, yöntem imzası verilmiştir:</span><span class="sxs-lookup"><span data-stu-id="71d12-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="71d12-191">Her istek ardışık düzeninde kimlik doğrulaması filtresini yöntemi çağrılır.</span><span class="sxs-lookup"><span data-stu-id="71d12-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="71d12-192">Kavramak önemlidir **ChallengeAsync** çağrılır *önce* oluşturulan ve denetleyici eylemi çalıştırılmadan önce büyük olasılıkla bile HTTP yanıtı.</span><span class="sxs-lookup"><span data-stu-id="71d12-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="71d12-193">Zaman **ChallengeAsync** çağrıldığında `context.Result` içeren bir **Ihttpactionresult**, daha sonra HTTP yanıtı oluşturmak için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="71d12-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="71d12-194">Bu nedenle **ChallengeAsync** olan çağrılır, HTTP yanıtı ilgili hiçbir şeyi henüz bilmiyorsanız önemli değildir.</span><span class="sxs-lookup"><span data-stu-id="71d12-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="71d12-195">**ChallengeAsync** yöntemi orijinal değerini değiştirin `context.Result` yeni bir **Ihttpactionresult**.</span><span class="sxs-lookup"><span data-stu-id="71d12-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="71d12-196">Bu **Ihttpactionresult** özgün sarmalamanız gerekir `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="71d12-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="71d12-197">Özgün adını veriyorum **Ihttpactionresult** *iç sonucu*ve yeni **Ihttpactionresult** *dış sonucu*.</span><span class="sxs-lookup"><span data-stu-id="71d12-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="71d12-198">Dış sonucu aşağıdakileri yapmalısınız:</span><span class="sxs-lookup"><span data-stu-id="71d12-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="71d12-199">HTTP yanıtı oluşturmak için iç sonucu çağırın.</span><span class="sxs-lookup"><span data-stu-id="71d12-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="71d12-200">Yanıt inceleyin.</span><span class="sxs-lookup"><span data-stu-id="71d12-200">Examine the response.</span></span>
3. <span data-ttu-id="71d12-201">Bir kimlik doğrulaması sınaması için yanıt, gerekirse ekleyin.</span><span class="sxs-lookup"><span data-stu-id="71d12-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="71d12-202">Aşağıdaki örnek, temel kimlik doğrulaması örnekten alınır.</span><span class="sxs-lookup"><span data-stu-id="71d12-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="71d12-203">Tanımladığı bir **Ihttpactionresult** dış sonuç.</span><span class="sxs-lookup"><span data-stu-id="71d12-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="71d12-204">`InnerResult` Özelliği tutan iç **Ihttpactionresult**.</span><span class="sxs-lookup"><span data-stu-id="71d12-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="71d12-205">`Challenge` Özelliğini bir Www doğrulama üstbilgisi temsil eder.</span><span class="sxs-lookup"><span data-stu-id="71d12-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="71d12-206">Dikkat **ExecuteAsync** önce çağırır `InnerResult.ExecuteAsync` HTTP yanıt oluşturan ve sonra gerekirse sınaması ekler.</span><span class="sxs-lookup"><span data-stu-id="71d12-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="71d12-207">Sınama eklemeden önce yanıt kodunu denetleyin.</span><span class="sxs-lookup"><span data-stu-id="71d12-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="71d12-208">Birçok kimlik doğrulama düzeni yalnızca bir sınama ekleme yanıt, burada gösterildiği gibi 401 ise.</span><span class="sxs-lookup"><span data-stu-id="71d12-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="71d12-209">Ancak, bazı kimlik doğrulama şeması bir sınama başarılı yanıt ekleyin.</span><span class="sxs-lookup"><span data-stu-id="71d12-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="71d12-210">Örneğin, [anlaş](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="71d12-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="71d12-211">Verilen `AddChallengeOnUnauthorizedResult` sınıfı, gerçek kod **ChallengeAsync** basittir.</span><span class="sxs-lookup"><span data-stu-id="71d12-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="71d12-212">Yalnızca sonuç oluşturun ve buna eklemek `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="71d12-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="71d12-213">Not: Temel kimlik doğrulaması örnek genişletme yönteminin yerleştirerek bu mantığı bir bit soyutlar.</span><span class="sxs-lookup"><span data-stu-id="71d12-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="71d12-214">Ana bilgisayar düzeyinde kimlik doğrulaması ile kimlik doğrulaması filtreleri birleştirme</span><span class="sxs-lookup"><span data-stu-id="71d12-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="71d12-215">"Ana bilgisayar düzeyinde kimlik doğrulaması" (IIS) gibi ana bilgisayar tarafından gerçekleştirilen kimlik doğrulaması önce istek ulaştığında Web API'si çerçevedir.</span><span class="sxs-lookup"><span data-stu-id="71d12-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="71d12-216">Genellikle, uygulamanızın rest ana bilgisayar düzeyinde kimlik doğrulamasını etkinleştirmek, ancak, Web APİ'si denetleyicilerinin için devre dışı bırakmak isteyebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="71d12-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="71d12-217">Örneğin, ana bilgisayar düzeyinde form kimlik doğrulamasını etkinleştirmek, ancak Web API'si için belirteç tabanlı kimlik doğrulaması kullanmak için tipik bir senaryo olur.</span><span class="sxs-lookup"><span data-stu-id="71d12-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="71d12-218">Web API ardışık düzeni içinde ana bilgisayar düzeyinde kimlik doğrulaması devre dışı bırakmak için çağrı `config.SuppressHostPrincipal()` yapılandırmanızda.</span><span class="sxs-lookup"><span data-stu-id="71d12-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="71d12-219">Web API'ı kaldırmak bu neden **IPrincipal** Web API ardışık düzenine girdikten herhangi bir istek.</span><span class="sxs-lookup"><span data-stu-id="71d12-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="71d12-220">Etkili bir şekilde, bu &quot;Çalıştır-kimlik doğrulaması&quot; istek.</span><span class="sxs-lookup"><span data-stu-id="71d12-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="71d12-221">Ek Kaynaklar</span><span class="sxs-lookup"><span data-stu-id="71d12-221">Additional Resources</span></span>

<span data-ttu-id="71d12-222">[ASP.NET Web API güvenliğini filtreler](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN dergisi)</span><span class="sxs-lookup"><span data-stu-id="71d12-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
